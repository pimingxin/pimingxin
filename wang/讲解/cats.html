<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>cats</title>
</head>
<body>
  <div>
    <button>GET cat</button>
  </div>
  <script>
    var btn = document.querySelector('button')
    var div = document.querySelector('div')

    function get(url,callback){
      var xhr = new XMLHttpRequest()
      xhr.open('get',url)
      xhr.addEventListener('load',()=>{//加载完成后
        callback(xhr.responseText)
      })
      xhr.send()
    }


    function getImage(url,callback){
      var img = document.createElement('img')
      img.onload = function(){
        callback(img)
      }
      img.src = url
    }







//请求全部图片
    // btn.addEventListener('click',e=> {
    //   btn.textContent = 'loading...'
    //   get('http://xieranmaya.github.io/images/cats/cats.json', (data) => {
    //     btn.textContent = 'show'
    //     var ary = JSON.parse(data)
    //     for(var imgObj of ary){
    //       var img = document.createElement('img')
    //       img.src = 'http://xieranmaya.github.io/images/cats/' + imgObj.url
    //       div.append(img)
    //     }
    //   })
    // })


    class Queue {
      constructor(){
        this.tasks = [] // 保存
        this.hasRunning = false
      }
      add(f){
        var next
        if (!this.hasRunning){
          this.hasRunning = true
          f(next = () =>{
            if (this.tasks.length){
              var nextTask = this.tasks.shift()
              nextTask(next)
            }else{
              this.hasRunning = false
            }
          })
        }else{
          this.tasks.push(f)
        }
        return this
      }
}


    var base = 'http://xieranmaya.github.io/images/cats/'

    btn.addEventListener('click',e=> {
      get('http://xieranmaya.github.io/images/cats/cats.json', (data) => {
        var ary = JSON.parse(data).slice(0,10)
        var i = 0
        var q = new Queue()
        
        for( var j= 0 ; j < ary.length ; j++){
          q = q.add(next => {
          getImage(`${base}${ary[i++].url}` , img => {
            div.append(img)
            next()
          })
        })
        }
        
        
 

/*
        var i = 0 
        f()//开始时需要调用 
        function f(){//声明f函数 然后运行
          if (i < ary.length){
            getImage(`${base}${ary[i++].url}` , (img) => {
              div.append(img)
              f()//自己调用一次 
            })
          }
        }*/
      })
    })
  
  </script>
</body>
</html>